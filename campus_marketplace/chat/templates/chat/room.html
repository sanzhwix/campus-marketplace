{% extends 'main/base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow chat-card">
            <div class="card-body">

                <h4 class="chat-title mb-3">
                    Chat about: <span>{{ room.product.name }}</span>
                </h4>

                <div id="messages" class="chat-messages">
                    {% for m in messages %}
                    <div class="chat-message">
                        <strong>{{ m.sender.first_name|default:m.sender.email }}:</strong>
                        <span>{{ m.content }}</span>
                    </div>
                    {% endfor %}
                </div>

                <form id="message-form" class="mt-3">
                    {% csrf_token %}
                    <div class="input-group chat-input-group">
                        <input
                            id="message-input"
                            name="message"
                            type="text"
                            class="form-control chat-input"
                            placeholder="Type your message..."
                            autocomplete="off"
                        >
                        <button class="btn btn-success chat-send-btn" id="send-btn" type="submit">
                            Send
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
(function () {
    const messagesEl = document.getElementById('messages');
    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');

    async function fetchMessages() {
        try {
            const resp = await fetch(`{% url 'chat:messages_api' room_id=room.id %}`);
            if (!resp.ok) return;
            const data = await resp.json();
            messagesEl.innerHTML = '';
            data.messages.forEach(m => {
                const div = document.createElement('div');
                div.className = 'chat-message';
                div.innerHTML = `<strong>${m.sender_name}:</strong> <span>${m.content}</span>`;
                messagesEl.appendChild(div);
            });
            messagesEl.scrollTop = messagesEl.scrollHeight;
        } catch (e) {
            console.error(e);
        }
    }

    setInterval(fetchMessages, 2500);
    fetchMessages();

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        const formData = new FormData();
        formData.append('message', text);

        const csrf = document.querySelector('input[name=csrfmiddlewaretoken]').value;

        try {
            const resp = await fetch(`{% url 'chat:messages_api' room_id=room.id %}`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrf },
                body: formData
            });

            if (resp.ok) {
                input.value = '';
                fetchMessages();
            }
        } catch (e) {
            console.error(e);
        }
    });
})();
</script>
{% endblock %}
