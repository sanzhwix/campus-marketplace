{% extends 'main/base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="mb-3">Chat about: {{ room.product.name }}</h4>

                <div id="messages" style="max-height:400px; overflow:auto; border:1px solid #eee; padding:10px;">
                    {% for m in messages %}
                    <div data-msg-id="{{ m.id }}"><strong>{{ m.sender.first_name|default:m.sender.email }}:</strong> {{
                        m.content }}</div>
                    {% endfor %}
                </div>

                <form id="message-form" class="mt-3">
                    {% csrf_token %}
                    <div class="input-group">
                        <input id="message-input" name="message" type="text" class="form-control"
                            placeholder="Type your message..." autocomplete="off">
                        <button class="btn btn-primary" id="send-btn" type="submit">Send</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const messagesEl = document.getElementById('messages');
        const form = document.getElementById('message-form');
        const input = document.getElementById('message-input');

        async function fetchMessages() {
            try {
                const resp = await fetch(`{% url 'chat:messages_api' room_id=room.id %}`);
                if (!resp.ok) return;
                const data = await resp.json();
                messagesEl.innerHTML = '';
                data.messages.forEach(m => {
                    const div = document.createElement('div');
                    div.dataset.msgId = m.id;
                    div.innerHTML = `<strong>${m.sender_name}:</strong> ${m.content}`;
                    messagesEl.appendChild(div);
                });
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (e) {
                console.error(e);
            }
        }

        // Poll every 2.5s
        setInterval(fetchMessages, 2500);
        fetchMessages();

        form.addEventListener('submit', async function (e) {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;
            const formData = new FormData();
            formData.append('message', text);
            // include csrf token
            const csrf = document.querySelector('input[name=csrfmiddlewaretoken]').value;
            try {
                const resp = await fetch(`{% url 'chat:messages_api' room_id=room.id %}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrf },
                    body: formData
                });
                if (resp.ok) {
                    input.value = '';
                    fetchMessages();
                } else {
                    const err = await resp.json();
                    alert(err.error || 'Could not send message');
                }
            } catch (e) {
                console.error(e);
            }
        });
    })();
</script>

{% endblock %}